name: 🩵 CI (build only) 🩵

on:
  pull_request:
    branches: [ "develop", "main" ]
    types: [ opened, synchronize, reopened, ready_for_review ]
  workflow_dispatch: { }

permissions:
  contents: read
  checks: write
  pull-requests: write
  issues: write

concurrency:
  group: pr-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - uses: gradle/actions/setup-gradle@v3
        if: ${{ !env.ACT }}
        with:
          cache-read-only: ${{ github.event_name == 'pull_request' }}
          gradle-home-cache-cleanup: true

      - name: Gradle assemble (no tests)
        id: assemble
        env:
          GRADLE_OPTS: "-Dorg.gradle.vfs.watch=false"
        run: |
          chmod +x ./gradlew
          ./gradlew assemble --no-daemon --stacktrace --info --no-watch-fs

      - name: Gradle test
        id: test
        continue-on-error: true
        env:
          GRADLE_OPTS: "-Dorg.gradle.vfs.watch=false"
        run: |
          ./gradlew test -Dspring.profiles.active=test \
            --no-daemon --stacktrace --info --no-watch-fs

      - name: Publish unit-test results (check UI)
        if: ${{ always() && !env.ACT && hashFiles('**/build/test-results/test/**/*.xml') != '' }}
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          files: "**/build/test-results/test/**/*.xml"
          comment_mode: off
          check_run: ${{ !github.event.pull_request.head.repo.fork }}
          job_summary: true

      - name: Compose message
        id: status
        if: ${{ always() }}
        run: |
          if [ "${{ steps.assemble.outcome }}" = "success" ]; then
            MSG="✅ Assemble 성공"
          else
            MSG="❌ Assemble 실패"
          fi

          if [ "${{ steps.test.outcome }}" = "success" ]; then
            MSG="$MSG"$'\n'"✅ Test 성공"
          else
            MSG="$MSG"$'\n'"❌ Test 실패"
          fi

          if [ "${{ steps.publish.outcome }}" = "failure" ]; then
            MSG="$MSG"$'\n'"⚠️ 테스트 리포트 게시 실패(권한/토큰 문제일 수 있음)"
          fi

          printf "message<<EOF\n%s\nEOF\n" "$MSG" >> "$GITHUB_OUTPUT"

      - name: Fail if any failed
        if: ${{ always() && (steps.assemble.outcome != 'success' || steps.test.outcome != 'success') }}
        run: exit 1
